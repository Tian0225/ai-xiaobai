# Milestone 3 - æ”¯ä»˜ç³»ç»Ÿé›†æˆ

**å®Œæˆæ—¥æœŸ**: 2026-02-11
**é¡¹ç›®**: AI-xiaobai
**è´Ÿè´£äºº**: é‡‘ç”° + Claude

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

Milestone 3 çš„ç›®æ ‡æ˜¯é›†æˆæ”¯ä»˜ç³»ç»Ÿï¼Œè®©ç”¨æˆ·å¯ä»¥è´­ä¹°å¹´åº¦ä¼šå‘˜ï¼ˆÂ¥499ï¼‰ã€‚æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š
- Supabase ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- ç»è¥æ”¶æ¬¾ç æ”¯ä»˜
- è½®è¯¢ API è‡ªåŠ¨å‘è´§
- ä¼šå‘˜æƒé™æ§åˆ¶

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. Supabase é›†æˆ

**å®‰è£…ä¾èµ–**:
```bash
npm install @supabase/supabase-js @supabase/ssr
```

**åˆ›å»ºçš„æ–‡ä»¶**:
- `lib/supabase/client.ts` - å®¢æˆ·ç«¯ Supabase å®ä¾‹
- `lib/supabase/server.ts` - æœåŠ¡ç«¯ Supabase å®ä¾‹
- `lib/supabase/middleware.ts` - ä¸­é—´ä»¶ session ç®¡ç†
- `lib/database.types.ts` - æ•°æ®åº“ç±»å‹å®šä¹‰

**ç¯å¢ƒé…ç½®**:
- æ›´æ–° `.env.local` å’Œ `.env.example`
- æ·»åŠ  Supabase URLã€API Key ç­‰é…ç½®
- æ·»åŠ æ”¯ä»˜ç›¸å…³ç¯å¢ƒå˜é‡

### 2. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

**è®¤è¯ UI**:
- `components/auth/auth-form.tsx` - ç™»å½•/æ³¨å†Œè¡¨å•ç»„ä»¶
- `app/auth/page.tsx` - è®¤è¯é¡µé¢
- `app/auth/callback/route.ts` - OAuth å›è°ƒå¤„ç†
- `components/auth/user-nav.tsx` - å¯¼èˆªæ ç”¨æˆ·çŠ¶æ€ç»„ä»¶

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… é‚®ç®± + å¯†ç æ³¨å†Œ
- âœ… é‚®ç®± + å¯†ç ç™»å½•
- âœ… é‚®ç®±éªŒè¯
- âœ… ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
- âœ… é€€å‡ºç™»å½•

### 3. ä¼šå‘˜è´­ä¹°ç³»ç»Ÿ

**ä¼šå‘˜é¡µé¢**:
- `app/membership/page.tsx` - ä¼šå‘˜è´­ä¹°é¡µé¢
- `components/payment/payment-form.tsx` - æ”¯ä»˜è¡¨å•ç»„ä»¶

**é¡µé¢åŠŸèƒ½**:
- âœ… ä¼šå‘˜æƒç›Šå±•ç¤ºï¼ˆ5å¤§æƒç›Šï¼‰
- âœ… ä»·æ ¼å±•ç¤ºï¼ˆÂ¥499/å¹´ï¼‰
- âœ… å·²ç™»å½•æ£€æµ‹ï¼ˆæœªç™»å½•è‡ªåŠ¨è·³è½¬ï¼‰
- âœ… ä¼šå‘˜çŠ¶æ€æ£€æµ‹ï¼ˆå·²æ˜¯ä¼šå‘˜æ˜¾ç¤ºåˆ°æœŸæ—¶é—´ï¼‰

### 4. æ”¯ä»˜æµç¨‹

**æ”¯ä»˜è¡¨å•åŠŸèƒ½**:
- âœ… é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼ˆå¾®ä¿¡/æ”¯ä»˜å®ï¼‰
- âœ… ç”Ÿæˆå”¯ä¸€è®¢å•å·ï¼ˆORDER_YYYYMMDD_XXXXXXï¼‰
- âœ… æ˜¾ç¤ºæ”¶æ¬¾äºŒç»´ç 
- âœ… è®¢å•å¤‡æ³¨æç¤º
- âœ… 10åˆ†é’Ÿå€’è®¡æ—¶
- âœ… è‡ªåŠ¨è½®è¯¢æ£€æµ‹æ”¯ä»˜ï¼ˆæ¯5ç§’ï¼‰
- âœ… æ”¯ä»˜æˆåŠŸè‡ªåŠ¨åˆ·æ–°

### 5. API è·¯ç”±

**è®¢å•ç®¡ç† API**:
- `app/api/orders/create/route.ts` - åˆ›å»ºè®¢å•
- `app/api/orders/check/route.ts` - æ£€æŸ¥è®¢å•çŠ¶æ€
- `app/api/orders/verify/route.ts` - éªŒè¯æ”¯ä»˜å¹¶å¼€é€šä¼šå‘˜

**æ”¯ä»˜è½®è¯¢é€»è¾‘**:
- `lib/payment/polling.ts` - æ”¯ä»˜è½®è¯¢å·¥å…·å‡½æ•°
  - å¾®ä¿¡æ”¯ä»˜ API é›†æˆï¼ˆå¾…å®ç°ï¼‰
  - æ”¯ä»˜å® API é›†æˆï¼ˆå¾…å®ç°ï¼‰
  - æ‰¹é‡æ£€æŸ¥å¾…æ”¯ä»˜è®¢å•ï¼ˆå¾…å®ç°ï¼‰

### 6. æƒé™æ§åˆ¶

**ä¸­é—´ä»¶**:
- `middleware.ts` - Next.js ä¸­é—´ä»¶
  - âœ… Session è‡ªåŠ¨åˆ·æ–°
  - âœ… å—ä¿æŠ¤è·¯å¾„æ£€æµ‹
  - âœ… æœªç™»å½•è‡ªåŠ¨é‡å®šå‘

**å—ä¿æŠ¤è·¯å¾„**:
- `/membership` - ä¼šå‘˜è´­ä¹°é¡µï¼ˆéœ€ç™»å½•ï¼‰
- `/api/orders/*` - è®¢å• APIï¼ˆéœ€ç™»å½•ï¼‰

### 7. å¸ƒå±€æ›´æ–°

**å¯¼èˆªç»„ä»¶**:
- `components/site-layout.tsx` - å…¨ç«™å¸ƒå±€ç»„ä»¶
  - âœ… å“åº”å¼å¯¼èˆªæ 
  - âœ… ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
  - âœ… ç™»å½•/æ³¨å†ŒæŒ‰é’®
  - âœ… æˆä¸ºä¼šå‘˜æŒ‰é’®
  - âœ… é¡µè„šç‰ˆæƒä¿¡æ¯

---

## ğŸ“š æ•°æ®åº“è®¾è®¡

### profiles è¡¨
```sql
- id (uuid, primary key)
- email (text)
- is_member (boolean)
- membership_expires_at (timestamp)
- created_at (timestamp)
- updated_at (timestamp)
```

### orders è¡¨
```sql
- id (uuid, primary key)
- order_id (text, unique)
- user_id (uuid)
- user_email (text)
- amount (numeric)
- payment_method (text: wechat | alipay)
- status (text: pending | paid | expired | cancelled)
- transaction_id (text, nullable)
- created_at (timestamp)
- paid_at (timestamp, nullable)
- expires_at (timestamp)
```

---

## ğŸ“– ä½¿ç”¨è¯´æ˜

### å¼€å‘ç¯å¢ƒé…ç½®

1. **åˆ›å»º Supabase é¡¹ç›®**:
   - è®¿é—® https://supabase.com
   - åˆ›å»ºæ–°é¡¹ç›®
   - è·å– API å¯†é’¥

2. **é…ç½®ç¯å¢ƒå˜é‡**:
   ```bash
   # å¤åˆ¶ .env.example åˆ° .env.local
   cp .env.example .env.local

   # å¡«å†™ Supabase é…ç½®
   NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
   ```

3. **åˆ›å»ºæ•°æ®åº“è¡¨**:
   - æŒ‰ç…§ `docs/supabase-setup.md` ä¸­çš„ SQL è„šæœ¬
   - åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
   - åˆ›å»º profiles å’Œ orders è¡¨
   - é…ç½® RLS ç­–ç•¥

4. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**:
   ```bash
   npm run dev
   ```

5. **æµ‹è¯•åŠŸèƒ½**:
   - è®¿é—® http://localhost:3000/auth æµ‹è¯•æ³¨å†Œ/ç™»å½•
   - è®¿é—® http://localhost:3000/membership æµ‹è¯•ä¼šå‘˜è´­ä¹°æµç¨‹

---

## âš ï¸ å¾…å®Œæˆäº‹é¡¹

### 1. æ”¯ä»˜ API é›†æˆ

**å¾®ä¿¡æ”¯ä»˜**:
- ç”³è¯·å¾®ä¿¡å•†æˆ·è´¦å·
- è·å–è´¦å•æŸ¥è¯¢ API æƒé™
- å®ç° `lib/payment/polling.ts` ä¸­çš„ `getWechatTransactions()`
- å‚è€ƒ: https://pay.weixin.qq.com/wiki/doc/api/native.php

**æ”¯ä»˜å®**:
- ç”³è¯·æ”¯ä»˜å®å¼€æ”¾å¹³å°è´¦å·
- è·å–è´¦å•æŸ¥è¯¢ API æƒé™
- å®ç° `lib/payment/polling.ts` ä¸­çš„ `getAlipayTransactions()`
- å‚è€ƒ: https://opendocs.alipay.com/

### 2. å®šæ—¶ä»»åŠ¡

**å®ç°è½®è¯¢æ£€æŸ¥**:
- ä½¿ç”¨ Vercel Cron Jobs æˆ–å…¶ä»–å®šæ—¶ä»»åŠ¡æœåŠ¡
- æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡å¾…æ”¯ä»˜è®¢å•
- è‡ªåŠ¨åŒ¹é…æ”¯ä»˜è®°å½•å¹¶å¼€é€šä¼šå‘˜

### 3. æ”¶æ¬¾ç ä¸Šä¼ 

**å‡†å¤‡æ”¶æ¬¾ç å›¾ç‰‡**:
```bash
# åœ¨ public/payment/ ç›®å½•æ”¾ç½®æ”¶æ¬¾ç 
public/
  payment/
    wechat-qr.png   # å¾®ä¿¡æ”¶æ¬¾ç 
    alipay-qr.png   # æ”¯ä»˜å®æ”¶æ¬¾ç 
```

### 4. é‚®ä»¶é€šçŸ¥

**é›†æˆé‚®ä»¶æœåŠ¡**:
- æ”¯ä»˜æˆåŠŸå‘é€ç¡®è®¤é‚®ä»¶
- ä¼šå‘˜åˆ°æœŸæé†’é‚®ä»¶
- å¯ä½¿ç”¨ Resendã€SendGrid ç­‰æœåŠ¡

---

## ğŸ§ª æµ‹è¯•æµç¨‹

### æœ¬åœ°æµ‹è¯•æ­¥éª¤

1. **æ³¨å†Œè´¦å·**:
   - è®¿é—® `/auth`
   - å¡«å†™é‚®ç®±å’Œå¯†ç 
   - æŸ¥æ”¶éªŒè¯é‚®ä»¶

2. **è´­ä¹°ä¼šå‘˜**:
   - ç™»å½•åè®¿é—® `/membership`
   - é€‰æ‹©æ”¯ä»˜æ–¹å¼
   - ç”Ÿæˆè®¢å•å’Œæ”¶æ¬¾ç 
   - æŸ¥çœ‹è®¢å•å·å’Œå€’è®¡æ—¶

3. **æ¨¡æ‹Ÿæ”¯ä»˜**:
   - æ‰‹åŠ¨è°ƒç”¨ `/api/orders/verify` API
   - ä¼ å…¥è®¢å•å·
   - éªŒè¯ä¼šå‘˜å¼€é€šæˆåŠŸ

4. **éªŒè¯æƒé™**:
   - åˆ·æ–°é¡µé¢
   - æŸ¥çœ‹ä¼šå‘˜çŠ¶æ€
   - ç¡®è®¤åˆ°æœŸæ—¶é—´æ˜¾ç¤ºæ­£ç¡®

---

## ğŸ“Š æŠ€æœ¯äº®ç‚¹

### 1. å®‰å…¨æ€§
- âœ… Supabase RLSï¼ˆRow Level Securityï¼‰
- âœ… æœåŠ¡ç«¯ API éªŒè¯
- âœ… è®¢å•å”¯ä¸€æ€§æ£€æŸ¥
- âœ… æ”¯ä»˜é‡‘é¢éªŒè¯

### 2. ç”¨æˆ·ä½“éªŒ
- âœ… å®æ—¶æ”¯ä»˜çŠ¶æ€æ£€æµ‹
- âœ… å€’è®¡æ—¶æç¤º
- âœ… æ¸…æ™°çš„è®¢å•å¤‡æ³¨è¯´æ˜
- âœ… æ”¯ä»˜æˆåŠŸè‡ªåŠ¨è·³è½¬

### 3. ä»£ç è´¨é‡
- âœ… TypeScript ç±»å‹å®‰å…¨
- âœ… ç»„ä»¶åŒ–è®¾è®¡
- âœ… API é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†æ³¨é‡Šæ–‡æ¡£

---

## ğŸš€ éƒ¨ç½²æ¸…å•

### Vercel éƒ¨ç½²

1. **ç¯å¢ƒå˜é‡é…ç½®**:
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - `SUPABASE_SERVICE_ROLE_KEY`
   - `NEXT_PUBLIC_WECHAT_QR_CODE`
   - `NEXT_PUBLIC_ALIPAY_QR_CODE`
   - `NEXT_PUBLIC_MEMBERSHIP_PRICE`

2. **Supabase URL ç™½åå•**:
   - æ·»åŠ ç”Ÿäº§åŸŸååˆ° Supabase é‡å®šå‘ç™½åå•

3. **ä¸Šä¼ æ”¶æ¬¾ç **:
   - å°†æ”¶æ¬¾ç å›¾ç‰‡æ”¾åˆ° `public/payment/`

4. **é…ç½®å®šæ—¶ä»»åŠ¡**:
   - åœ¨ Vercel é…ç½® Cron Jobs
   - æˆ–ä½¿ç”¨ç¬¬ä¸‰æ–¹å®šæ—¶ä»»åŠ¡æœåŠ¡

---

## ğŸ“ æ€»ç»“

Milestone 3 æˆåŠŸå®ç°äº†å®Œæ•´çš„æ”¯ä»˜ç³»ç»ŸåŸºç¡€æ¶æ„ï¼š

âœ… **å·²å®Œæˆ**:
- Supabase ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- ä¼šå‘˜è´­ä¹°æµç¨‹ UI
- è®¢å•ç®¡ç† API
- æ”¯ä»˜è½®è¯¢æ¡†æ¶
- æƒé™æ§åˆ¶ä¸­é—´ä»¶
- æ•°æ®åº“è®¾è®¡å’Œé…ç½®

ğŸš§ **å¾…é›†æˆ**:
- å¾®ä¿¡/æ”¯ä»˜å®çœŸå® API
- å®šæ—¶ä»»åŠ¡è½®è¯¢
- é‚®ä»¶é€šçŸ¥æœåŠ¡

**ä¸‹ä¸€æ­¥**: å‡†å¤‡å¥½æ”¯ä»˜ API åï¼Œå³å¯ä¸Šçº¿æµ‹è¯•çœŸå®æ”¯ä»˜æµç¨‹ï¼

---

**ç›¸å…³æ–‡æ¡£**:
- [Supabase é…ç½®æŒ‡å—](../supabase-setup.md)
- [PRD æ–‡æ¡£](/Users/jitian/Documents/é‡‘ç”°å·¥ä½œå®¤/ç»éªŒåº“/AI-xiaobaiç½‘ç«™å¼€å‘PRD.md)
