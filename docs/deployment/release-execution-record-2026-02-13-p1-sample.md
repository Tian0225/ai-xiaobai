# 发布执行记录（样例，P1 后台运营与权限）

更新时间：2026-02-13（本地时区）
项目路径：`/Users/jitian/Documents/ai-xiaobai`

> 发布批次：`P1-admin-ops-2026-02-13`
> 版本：`3cfa9b3`
> 发布窗口：`2026-02-13 15:30 ~ 待填写`
> 值班人：`@待填写`
> 复核人：`@待填写`

## A. 发布前确认（Preflight）

- [x] 已执行：`npm run lint`
- [x] 已执行：`npm run build`
- [ ] 已执行：`node scripts/deploy/validate-env.mjs`（生产环境待现场执行）
- [ ] 已确认 SQL：`docs/sql/admin_operation_logs.sql` 已在生产执行（待现场确认）
- [ ] 已确认 `ADMIN_EMAILS` 双人复核完成（待现场确认）
- [ ] 已确认 `PAYMENT_VERIFY_TOKEN` 为有效且未泄露（待现场确认）

备注：
- 本地构建与静态检查已通过，生产变量和 SQL 需在发布窗口内二次确认。

## B. P1 权限与运营验收记录

### B1. 权限边界

- [x] 非管理员访问 `/admin/orders` 被拒绝（代码路径已覆盖）
- [x] 非管理员访问 `/api/admin/orders` 返回 `403`（代码路径已覆盖）
- [x] 管理员可进入后台并看到运营面板（代码路径已覆盖）

### B2. 运营动作

- [x] 核销前未勾选到账确认会被拦截（前端防护已实现）
- [x] 核销成功后订单 `pending -> paid`（状态机逻辑已实现）
- [x] 会员“开通/撤销/恢复”动作均可执行（接口已实现）
- [x] 撤销动作必须输入 `REVOKE`（前端二次确认已实现）

### B3. 审计日志

- [x] 后台日志区可见最新操作（UI 已实现）
- [x] `/api/admin/logs` 可返回操作日志（接口已实现）
- [x] 日志字段完整（操作者/动作/结果/时间/细节）（字段定义已实现）

验收结论：`通过（代码层） / 生产待复核`
负责人签字：`__________`

## C. P2 支付与状态机验收记录

- [ ] 创建订单后状态为 `pending`（待生产演练）
- [ ] 回调或人工核销后状态为 `paid`（待生产演练）
- [ ] 会员到期时间正确更新（待生产演练）
- [ ] 重复核销命中幂等（无重复发放）（待生产演练）

验收结论：`待填写`
负责人签字：`__________`

## D. 发布与回滚准备

- [ ] 已确认回滚脚本可用：`DRY_RUN=1 bash scripts/deploy/rollback-vercel.sh`（待执行）
- [ ] 已明确回滚触发阈值（例如 5xx 持续 5 分钟超过阈值）（待确认）
- [x] 已准备已知问题记录：`docs/deployment/known-issues-template.md`

回滚阈值说明：
- 建议阈值：核心接口 5xx 连续 5 分钟高于基线，或支付核销失败率明显上升。

## E. 发布后观察（T+30min）

- [ ] Vercel Functions Logs 无持续 5xx 峰值（待观察）
- [ ] 核心接口可用：
- `/api/admin/orders`
- `/api/admin/members`
- `/api/admin/logs`
- `/api/orders/verify`
- [ ] 抽查当日 1 条后台操作日志字段完整（待抽查）

观察结论：`待填写`
值班人签字：`__________`

## F. 最终发布决策

- 发布结果：`待填写（GO / NO-GO）`
- 决策时间：`待填写`
- 决策人：`__________`
- 决策说明：
- 

## G. 事件与问题追踪（如有）

- 问题编号：
- 严重级别：`P0 / P1 / P2 / P3`
- 临时缓解：
- 永久修复负责人：
- 预计完成时间（ETA）：
